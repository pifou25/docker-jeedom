name: Docker Image CI

on:
  push:
    branches: [ feat/script_rate_limit ]
  pull_request:
    branches: [ none ]
  # this is to manually trigger the worklow
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Reason'     
        default: 'Manual launch'

env:
  # used to download jeedom source
  # JEEDOM_REPO: ${{ github.ref_name == 'master' && 'jeedom/core' || 'pifou25/jeedom-core' }}
  JEEDOM_REPO: jeedom/core
  # branch to use: master if the current branch is master, develop if not
  # this is used to set the jeedom version in the Dockerfile
  # JEEDOM_BRANCH: ${{ github.ref_name == 'master' && 'master' || 'develop' }}
  JEEDOM_BRANCH: master
  # destination docker registry image name
  REGISTRY_IMAGE: pifou25/jeedom
  # XDEBUG enabled by default for develop and beta branches
  XDEBUG: ${{ github.ref_name == 'master' && 'false' || 'true' }}
  DEBIAN: trixie
  PHP: 8.4
  DOCKER_BUILDKIT: 1
  BUILDKIT_INSECURE_REGISTRY: registry:5000

jobs:

  build:
  # this step use only simple scripts commands

    runs-on: ubuntu-latest

    env:
      DOCKER_BUILDKIT: 1
      BUILDKIT_INSECURE_REGISTRY: registry-mirror:5000
      # used to download jeedom source
      # JEEDOM_REPO: ${{ github.ref_name == 'master' && 'jeedom/core' || 'pifou25/jeedom-core' }}
      JEEDOM_REPO: jeedom/core
      # branch to use: master if the current branch is master, develop if not
      # this is used to set the jeedom version in the Dockerfile
      # JEEDOM_BRANCH: ${{ github.ref_name == 'master' && 'master' || 'develop' }}
      JEEDOM_BRANCH: master
      # destination docker registry image name
      REGISTRY_IMAGE: pifou25/jeedom
      # XDEBUG enabled by default for develop and beta branches
      XDEBUG: ${{ github.ref_name == 'master' && 'false' || 'true' }}
      DEBIAN: trixie
      PHP: 8.4
      # RÃ©fÃ©rence vers le cache du registre
      REGISTRY_CACHE: ghcr.io/pifou25/docker-jeedom
      CACHE_NAME: trixie-8.4
      
    # continue to next job even if there are some errors in jbuild job
    continue-on-error: true
    strategy:
      # do every matrix combination, don't stop on errors
      fail-fast: false
      # limit to avoid error HTTP 409: too many requests
      max-parallel: 2
      matrix:
        # target: ["light" , "full"]
        debian: [bullseye, bookworm, trixie]
        php: [7.4, 8.2, 8.4]
        # linux/amd64,linux/amd64/v2,linux/amd64/v3,linux/arm64,linux/riscv64,linux/ppc64le,linux/s390x,linux/386,linux/mips64le,linux/mips64,linux/arm/v7,linux/arm/v6
        platform: [amd64, arm64, arm/v6, arm/v7]
        # only build bullseye with php7.4, bookworm with php8.2 and trixie with php8.4
        exclude:
          - debian: bookworm
            php: 7.4
          - debian: bookworm
            php: 8.4
          - debian: bullseye
            php: 8.2
          - debian: bullseye
            php: 8.4
          - debian: trixie
            php: 8.2
          - debian: trixie
            php: 7.4

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      -
        name: Login to nico private repository
        # https://github.com/marketplace/actions/docker-login
        uses: docker/login-action@v3
        with:
          registry: reg.nico.si
          username: ${{ github.repository_owner }}
          password: ${{ secrets.NICO_PASSWORD }}

      # pull image from docker hub and check it is available into the registry-mirror
      - name: Test private repository
        run: |
         docker pull php:${{ matrix.php }}-apache-${{ matrix.debian }} --platform linux/${{ matrix.platform }}
         docker tag php:${{ matrix.php }}-apache-${{ matrix.debian }} reg.nico.si/php:${{ matrix.php }}-apache-${{ matrix.debian }}-${{ matrix.platform }}
         docker push reg.nico.si/php:${{ matrix.php }}-apache-${{ matrix.debian }}-${{ matrix.platform }}
         exit 1

      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with login & secrets token - for pull to avoid error HTTP 429 Too many requests
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - 
        name: Login to GitHub Container Registry
        # ðŸ”¹ Service de cache Docker Registry ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_SECRET }}
        
      - name: Run DockerHub rate limit check
        id: ratecheck
        run: |
          chmod +x .github/scripts/rate_limit.sh
          ./.github/scripts/rate_limit.sh

      - name: Add summary to Job Summary
        run: |
          echo "### ðŸ³ DockerHub Pull Limit" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.ratecheck.outputs.summary }}" >> $GITHUB_STEP_SUMMARY

      - name: check Docker.io rate limit
        if: ${{ steps.ratecheck.outputs.remaining && (steps.ratecheck.outputs.remaining < 10) }}
        run: |
          echo "âš ï¸ Il reste moins de 10 pulls : ${{ steps.ratecheck.outputs.remaining }} / ${{ steps.ratecheck.outputs.limit }}" >> $GITHUB_STEP_SUMMARY && exit 1

      - name: Set up Docker Buildx
        # https://github.com/marketplace/actions/docker-setup-buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          name: jeedom-builder
          buildkitd-flags: --allow-insecure-entitlement security.insecure --allow-insecure-entitlement network.host
          buildkitd-config-inline: |
            [registry."registry-mirror:5000"]
              http = true
              insecure = true

      #- name: Enable buildx
      #  run: |
      #    docker buildx create --use --name jeedom-builder --driver docker-container --driver-opt network=buildnet
      #    docker buildx inspect --bootstrap
      - name: Build with cache using previous builder
        # docker build --builder [name] --build-arg [arg=value] --file [file] --tag [tag] [directory]
        run: |
          docker buildx build --builder jeedom-builder  \
            --build-arg DEBIAN=${{ env.DEBIAN }} \
            --build-arg PHP=${{ env.PHP }} \
            --build-arg JEEDOM_REPO=${{ env.JEEDOM_REPO }} \
            --build-arg JEEDOM_VERSION=${{ env.JEEDOM_BRANCH }} \
            --build-arg XDEBUG=false \
            --build-arg XTRARGS=-light \
            --cache-from type=registry,ref=${{ env.REGISTRY_CACHE }}:${{ env.CACHE_NAME }} \
            --cache-to type=registry,ref=${{ env.REGISTRY_CACHE }}:${{ env.CACHE_NAME }},mode=max \
            --file build/Dockerfile \
            --tag ghcr.io/${{ env.REGISTRY_IMAGE }}:test \
            --load build

      - name: Docker Push
        run: |
          docker push ghcr.io/${{ secrets.DOCKER_USER }}/jeedom:test
        
      - name: Run DockerHub rate limit final check
        id: ratecheckFinal
        run: |
          chmod +x .github/scripts/rate_limit.sh
          ./.github/scripts/rate_limit.sh

      - name: Add summary to Job Summary
        run: |
          echo "### ðŸ³ DockerHub Pull Limit" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.ratecheckFinal.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
