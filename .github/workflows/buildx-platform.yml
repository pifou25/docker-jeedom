name: Docker Multiplatform Build ci
# master branch build image from jeedom/core:master repo
# develop branch build image from pifou25/jeedom-core:develop repo

on:
  push:
    branches:
      - 'master'
      - 'develop'
      - 'feat/service_registry2'
  # this is to manually trigger the worklow
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Reason'     
        default: 'Manual launch'

# no concurrency, cancel previous running workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # used to download jeedom source
  JEEDOM_REPO: ${{ github.ref_name == 'master' && 'jeedom/core' || 'pifou25/jeedom-core' }}
  # branch to use: master if the current branch is master, develop if not
  # this is used to set the jeedom version in the Dockerfile
  JEEDOM_BRANCH: ${{ github.ref_name == 'master' && 'master' || 'develop' }}
  # destination docker registry image name
  REGISTRY_IMAGE: pifou25/jeedom
  # XDEBUG enabled by default for develop and beta branches
  XDEBUG: ${{ github.ref_name == 'master' && 'false' || 'true' }}
  # Active BuildKit
  DOCKER_BUILDKIT: 1

jobs:
  # clean runner and Lint the Dockerfile
  initStep:
    runs-on: ubuntu-latest
    steps:
      - name: Remove old artifacts
        # https://github.com/marketplace/actions/remove-artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '10 seconds'
      -
        name: Checkout
        uses: actions/checkout@v4.1.2
      - name: Docker Lint
        # https://github.com/marketplace/actions/hadolint-action
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: build/Dockerfile
          no-fail: true
          verbose: true
      - name: Docker Lint
        # https://github.com/marketplace/actions/hadolint-action
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: build/Dockerfile.full
          no-fail: true
          verbose: true

  jbuild:
    # https://docs.docker.com/build/ci/github-actions/multi-platform/
    # distributebuild across multiple runners
    # This step  build the same image on different runners / platforms
    runs-on: ubuntu-latest
    needs: initStep

    # continue to next job even if there are some errors in jbuild job
    continue-on-error: true
    strategy:
      # do every matrix combination, don't stop on errors
      fail-fast: false
      # limit to avoid error HTTP 409: too many requests
      max-parallel: 3
      matrix:
        target: ["light" , "full"]
        debian: [bullseye, bookworm, trixie]
        php: [7.4, 8.2, 8.4]
        # linux/amd64,linux/amd64/v2,linux/amd64/v3,linux/arm64,linux/riscv64,linux/ppc64le,linux/s390x,linux/386,linux/mips64le,linux/mips64,linux/arm/v7,linux/arm/v6
        platform: [amd64, arm64, arm/v6, arm/v7]
        # only build bullseye with php7.4, bookworm with php8.2 and trixie with php8.4
        exclude:
          - debian: bookworm
            php: 7.4
          - debian: bookworm
            php: 8.4
          - debian: bullseye
            php: 8.2
          - debian: bullseye
            php: 8.4
          - debian: trixie
            php: 8.2
          - debian: trixie
            php: 7.4
          - debian: bullseye
            platform: 'arm/v6'
          - debian: bullseye
            platform: 'arm/v7'


    env:
      # tag name de la forme: debian-php-light-debug-dev e.g. bullseye-8.2-light-debug-dev
      TAG_NAME: ${{ matrix.debian }}-${{ matrix.php }}${{ matrix.target == 'light' && '-light' || '' }}${{ github.ref_name != 'master' && '-dev' || '' }}
      TAG_LATEST_ENABLED: ${{ (matrix.debian == 'bullseye' && matrix.target == 'full' && matrix.target == 'full' && github.ref_name == 'master') }}
      CACHE_NAME: ${{ matrix.debian }}-${{ matrix.platform }}-${{ matrix.php }}
      # R√©f√©rence vers le cache du registre
      REGISTRY_CACHE: ghcr.io/pifou25/docker-jeedom

    steps:
      -
        name: Prepare ${{ env.TAG_NAME }}:${{ matrix.platform }}
        # replace /  by - in platform value and registry cache name
        run: |
          platform=linux/${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_STEP_SUMMARY
          # docker login ghcr.io -u ${{ github.repository_owner }} -p ${{ secrets.GHCR_SECRET }}

      # prepare image cache for local registry
      # https://github.com/marketplace/actions/cache
      - id: image-cache
        uses: actions/cache@v4.2.2
        with:
          path: /tmp/registry-cache
          key: registry-cache

      # local registry for docker cache
      - name: Start local Docker registry (mirror/cache)
        run: |
          docker run -d -p 5000:5000 --restart=always --name registry \
            -v /tmp/docker-registry:/var/lib/registry \
            registry:2
          npx wait-on tcp:5000

      -
        name: Checkout
        uses: actions/checkout@v4.1.2
          
      - name: Warm-up build (fills local daemon cache)
        # √©tape de pr√©chauffage du cache docker
        run: |
          docker buildx build --load \
            --platform linux/amd64 \
            --build-arg DEBIAN=${{ matrix.debian }} \
            --build-arg PHP=${{ matrix.php }} \
            --network=host \
            --file build/Dockerfile \
            build

      - 
        name: Login to GitHub Container Registry
        # üîπ Service de cache Docker Registry ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_SECRET }}
        
      -
        name: Docker meta
        id: meta
        # https://github.com/marketplace/actions/docker-metadata-action
        uses: docker/metadata-action@v5
        with:
          # list of Docker images to use as base name for tags
          images: |
            ${{ env.REGISTRY_IMAGE }}
          # generate Docker tags based on the following events/attributes
          tags: |
            type=raw,value=${{ env.TAG_NAME }}
            # set latest tag for default branch
            type=raw,value=latest,enable=${{ env.TAG_LATEST_ENABLED }}

      -
        name: Set up QEMU
        # https://github.com/marketplace/actions/docker-setup-qemu
        # set up more platforms (default = all)
        uses: docker/setup-qemu-action@v3
      -
        name: Set up Docker Buildx
        id: buildx
        # https://github.com/marketplace/actions/docker-setup-buildx
        # set up a multi-platform builder for Docker containers
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
          buildkitd-flags: --debug
          install: true
          driver: docker-container

      - 
        name: build ${{ env.TAG_NAME }}:${{ matrix.platform }}
        # id required for next step that check success
        id: buildJeedom
        # https://github.com/marketplace/actions/build-and-push-docker-images
        uses: docker/build-push-action@v5
        # continue to next step even in case of error
        continue-on-error: true
        with:
          context: build
          file: build/Dockerfile${{ matrix.target != 'light' && '.full' || '' }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            DEBIAN=${{ matrix.debian }}
            PHP=${{ matrix.php }}
            JEEDOM_REPO=${{ env.JEEDOM_REPO }}
            JEEDOM_VERSION=${{ env.JEEDOM_BRANCH }}
            XDEBUG=${{ env.XDEBUG }}
            XTRARGS=${{ env.XDEBUG && '-light-dev' || '-light' }}
          platforms: linux/${{ matrix.platform }}
          cache-from: type=registry,ref=${{ env.REGISTRY_CACHE }}:${{ env.CACHE_TAG }}
          cache-to: type=registry,ref=${{ env.REGISTRY_CACHE }}:${{ env.CACHE_TAG }},mode=max
          outputs: type=image,name=${{ env.REGISTRY_IMAGE }},push-by-digest=true,name-canonical=true,push=true

      - name: Check on failures ${{ env.TAG_NAME }}:${{ matrix.platform }}
        if: steps.buildJeedom.outcome != 'success'
        # some debug information in case of error, exit with error
        run: |
          echo "${{ matrix.platform}} ${{ matrix.debian }} PHP${{ matrix.php }} ${{ matrix.target }} branch ${{ env.JEEDOM_BRANCH }} debug=${{ env.XDEBUG }} has Errors! üöÄ" >> $GITHUB_STEP_SUMMARY
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          Labels: ${{ steps.meta.outputs.labels }}
          EOF
          exit 1

      -
        name: Export digest ${{ env.TAG_NAME }}:${{ matrix.platform }}
        # export the digest file name into env var named DIGEST-${TAG_NAME} for next step
        if: steps.buildJeedom.outcome == 'success'
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.buildJeedom.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"
      -
        name: Upload digest ${{ env.TAG_NAME }}:${{ matrix.platform }}
        if: steps.buildJeedom.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          # env.PLATFORM_PAIR from step 1
          # get DIGEST-${TAG_NAME} env variable from previous step
          name: digests-${{ env.TAG_NAME }}-${{ env.PLATFORM_PAIR }}
          path: /tmp/digests/${{ env.DIGEST }}
          if-no-files-found: error
          retention-days: 1

  merge:
    # https://docs.docker.com/build/ci/github-actions/multi-platform/
    # merge previous builds from different runners & platforms into one common docker image
    runs-on: ubuntu-latest
    needs:
      - jbuild

    # same matrix as previous step except the platform
    strategy:
      fail-fast: false
      # limit to avoid error HTTP 409: too many requests
      max-parallel: 1
      matrix:
        target: ["light" , "full"]
        debian: [bullseye, bookworm, trixie]
        php: [7.4, 8.2, 8.4]
        # only build bullseye with php7.4, bookworm with php8.2 and trixie with php8.4
        exclude:
          - debian: bookworm
            php: 7.4
          - debian: bookworm
            php: 8.4
          - debian: bullseye
            php: 8.2
          - debian: bullseye
            php: 8.4
          - debian: trixie
            php: 8.2
          - debian: trixie
            php: 7.4

    env:
      TAG_NAME: ${{ matrix.debian }}-${{ matrix.php }}${{ matrix.target == 'light' && '-light' || '' }}${{ github.ref_name != 'master' && '-dev' || '' }}
      TAG_LATEST_ENABLED: ${{ (matrix.debian == 'bullseye' && matrix.target == 'full' && matrix.target == 'full' && github.ref_name == 'master') }}

    steps:

      # prepare image cache for local registry
      # https://github.com/marketplace/actions/cache
      - id: image-cache
        uses: actions/cache@v4.2.2
        with:
          path: /tmp/registry-cache
          key: registry-cache

      # local registry for docker cache
      - name: Start local Docker registry (mirror/cache)
        run: |
          docker run -d -p 5000:5000 --restart=always --name registry \
            -v /tmp/docker-registry:/var/lib/registry \
            registry:2
          npx wait-on tcp:5000
      -
        name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-${{ env.TAG_NAME }}-*
          merge-multiple: true

      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with secrets login & token
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Docker meta
        id: meta
        # https://github.com/marketplace/actions/docker-metadata-action
        uses: docker/metadata-action@v5
        with:
          # list of Docker images to use as base name for tags
          images: |
            ${{ env.REGISTRY_IMAGE }}
          # generate Docker tags based on the following events/attributes
          tags: |
            type=raw,value=${{ env.TAG_NAME }}
            # set latest tag for default branch
            type=raw,value=latest,enable=${{ env.TAG_LATEST_ENABLED }}
          # label chadburn for the "cron" container
          labels: |
            org.opencontainers.image.created=${{ env.CURRENT_DATETIME }}
            org.opencontainers.image.revision=${{ github.sha }}
            chadburn.enabled=true
            chadburn.job-exec.jeedom-cron.schedule=@every 1m
            chadburn.job-exec.jeedom-cron.command="/usr/local/bin/php /var/www/html/core/php/jeeCron.php >> /var/www/html/log/cron.log 2>&1"

      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with secrets login & token
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}
 
      -
        name: Create manifest list and push ${{ env.TAG_NAME }}
        working-directory: /tmp/digests
        run: |
          # debug tmp directory
          ls /tmp -alsh
          echo jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON"
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.REGISTRY_IMAGE }}@sha256:%s ' *)

      - 
        name: Login to GitHub Container Registry
        # push to multi-registry
        # https://docs.docker.com/build/ci/github-actions/push-multi-registries/
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_SECRET }}
    
      - name: Push image to GHCR
        id: ghcr-push
        # continue to next step even in case of error
        continue-on-error: true
        run: |
          docker buildx imagetools create \
            ${{ env.TAG_LATEST_ENABLED && '--tag ghcr.io/${REGISTRY_IMAGE}:latest' || '' }} \
            --tag ghcr.io/${{ env.REGISTRY_IMAGE }}:${{ env.TAG_NAME }} \
            ${{ env.REGISTRY_IMAGE }}:${{ env.TAG_NAME }}

      -
        name: Login to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USER }}
          password: ${{ secrets.QUAY_PASSWORD }}
         
      - name: Push image to Quay.io
        id: quay-push
        # continue to next step even in case of error
        continue-on-error: true
        run: |
          docker buildx imagetools create \
            ${{ env.TAG_LATEST_ENABLED && '--tag quay.io/${REGISTRY_IMAGE}:latest' || '' }} \
            --tag quay.io/${{ env.REGISTRY_IMAGE }}:${{ env.TAG_NAME }} \
            ${{ env.REGISTRY_IMAGE }}:${{ env.TAG_NAME }}

      - name: Check push into quay.io ${{ env.TAG_NAME }}
        if: steps.quay-push.outcome != 'success' || steps.ghcr-push.outcome != 'success'
        run: |
          if [ "${{ steps.ghcr-push.outcome }}" != "success" ]; then \
            echo "Fail pushing ${TAG_NAME} to ghcr.io ! üöÄ (probably error HTTP 429 Too many requests)" >> $GITHUB_STEP_SUMMARY; \
          else \
            echo "Successfull pushing ${TAG_NAME} to ghcr.io üöÄ" >> $GITHUB_STEP_SUMMARY; \
          fi
          if [ "${{ steps.quay-push.outcome }}" != "success" ]; then \
            echo "Fail pushing ${TAG_NAME} to quay.io ! üöÄ (probably error HTTP 429 Too many requests)" >> $GITHUB_STEP_SUMMARY; \
          else \
            echo "Successfull pushing ${TAG_NAME} to quay.io üöÄ" >> $GITHUB_STEP_SUMMARY; \
          fi
          exit 1

  conclusion:
    # login to Docker.io and check remaining rate limit
    needs: [merge]
    if: always()
    runs-on: ubuntu-latest
    steps:

      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with secrets login & token - for pull to avoid error HTTP 429 Too many requests
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: check Docker.io rate limit
        run: |
          #!/usr/bin/env bash
          # V√©rifie la limite et le nombre de pulls restants sur Docker Hub

          # D√©pendances : curl + jq
          if ! command -v jq >/dev/null 2>&1; then
            echo "‚ùå jq est requis (sudo apt install jq ou brew install jq)"
            exit 1
          fi

          # 1Ô∏è‚É£ R√©cup√®re un token d'authentification pour une image publique
          TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:ratelimitpreview/test:pull" \
            | jq -r '.token')

          if [[ -z "$TOKEN" || "$TOKEN" == "null" ]]; then
            echo "‚ùå Impossible d'obtenir un token Docker Hub"
            exit 1
          fi

          # 2Ô∏è‚É£ Interroge le registre pour obtenir les infos de quota
          HEADERS=$(curl -s -I -H "Authorization: Bearer $TOKEN" \
            https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest)

          # Exemple de lignes :
          # RateLimit-Limit: 100;w=21600
          # RateLimit-Remaining: 73;w=21600

          # Extraire limite + fen√™tre
          read LIMIT WINDOW < <(echo "$HEADERS" | grep -i "RateLimit-Limit" | sed -E 's/.*: ([0-9]+);w=([0-9]+)/\1 \2/')
          # Extraire le nombre restant
          read REMAINING _ < <(echo "$HEADERS" | grep -i "RateLimit-Remaining" | sed -E 's/.*: ([0-9]+);w=([0-9]+)/\1 \2/')

          # 3Ô∏è‚É£ Affiche un r√©sum√© propre
          if [[ -n "$LIMIT" && -n "$REMAINING" && -n "$WINDOW" ]]; then
            CURRENT_DATETIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            HOURS=$(awk "BEGIN {printf \"%.1f\", $WINDOW/3600}")
            echo "‚úÖ Pulls restants au ${CURRENT_DATETIME} : $REMAINING / $LIMIT (fen√™tre de ${HOURS}h)"
          else
            echo "‚ö†Ô∏è Impossible de lire les en-t√™tes RateLimit"
            echo "$HEADERS"
          fi
