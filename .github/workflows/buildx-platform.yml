name: Docker Multiplatform Build ci
# master branch build image from jeedom/core:master repo
# develop branch build image from pifou25/jeedom-core:develop repo

on:
  # this is to manually trigger the worklow
  workflow_dispatch:
    inputs:
      target:
        description: 'light ou full, cible du build Ã  gÃ©nÃ©rer'     
        default: 'light'
      version_tag:
        description: 'version de jeedom Ã  utiliser'     
        default: "4.5"

  # reusable workflow
  workflow_call:
    inputs:
      # target is light for the first stage or full  for complete image build
      target:
        required: true
        type: string
      version_tag:
        description: 'version de jeedom Ã  utiliser'
        required: true
        type: string
        default: "4.5"

    secrets:
      GHCR_SECRET:
        required: true
      DOCKER_PASSWORD:
        required: true
      QUAY_USER:
        required: true
      QUAY_PASSWORD:
        required: true
      NICO_PASSWORD:
        required: true


# no concurrency, cancel previous running workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # used to download jeedom source
  JEEDOM_REPO: ${{ github.ref_name == 'master' && 'jeedom/core' || 'pifou25/jeedom-core' }}
  # branch to use: master if the current branch is master, develop if not
  # this is used to set the jeedom version in the Dockerfile
  JEEDOM_BRANCH: ${{ github.ref_name == 'master' && 'master' || 'develop' }}
  # destination docker registry image name
  REGISTRY_IMAGE: pifou25/jeedom
  # XDEBUG enabled by default for develop and beta branches
  XDEBUG: ${{ github.ref_name == 'master' && 'false' || 'true' }}
  # Active BuildKit
  DOCKER_BUILDKIT: 1

jobs:
  # clean runner and Lint the Dockerfile
  initStep:
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v4.1.2
      - name: Docker Lint
        # https://github.com/marketplace/actions/hadolint-action
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: build/Dockerfile
          no-fail: true
          verbose: true
      - name: Docker Lint
        # https://github.com/marketplace/actions/hadolint-action
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: build/Dockerfile.full
          no-fail: true
          verbose: true
      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with login & secrets token to get our private rate limit
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Run DockerHub rate limit check
        id: ratecheck
        run: |
          chmod +x .github/scripts/rate_limit.sh
          ./.github/scripts/rate_limit.sh

      - name: Add summary to Job Summary
        run: |
          echo "### ðŸ³ DockerHub Pull Limit" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.ratecheck.outputs.summary }}" >> $GITHUB_STEP_SUMMARY

      - name: check Docker.io rate limit
        if: ${{ steps.ratecheck.outputs.remaining && (steps.ratecheck.outputs.remaining < 10) }}
        run: |
          echo "âš ï¸ Il reste moins de 10 pulls : ${{ steps.ratecheck.outputs.remaining }} / ${{ steps.ratecheck.outputs.limit }}" >> $GITHUB_STEP_SUMMARY && exit 1

  jbuild:
    # https://docs.docker.com/build/ci/github-actions/multi-platform/
    # distribute build across multiple runners
    # This step  build the same image on different runners / platforms
    runs-on: ubuntu-latest
    needs: initStep

    # continue to next job even if there are some errors in jbuild job
    continue-on-error: true
    strategy:
      # do every matrix combination, don't stop on errors
      fail-fast: false
      # limit to avoid error HTTP 409: too many requests
      max-parallel: 4
      matrix:
        debian: [bullseye, bookworm, trixie]
        php: [7.4, 8.2, 8.4]
        # linux/amd64,linux/amd64/v2,linux/amd64/v3,linux/arm64,linux/riscv64,linux/ppc64le,linux/s390x,linux/386,linux/mips64le,linux/mips64,linux/arm/v7,linux/arm/v6
        platform: [amd64, arm64, arm/v6, arm/v7]
        # only build bullseye with php7.4, bookworm with php8.2 and trixie with php8.4
        exclude:
          - debian: bookworm
            php: 7.4
          - debian: bookworm
            php: 8.4
          - debian: bullseye
            php: 8.2
          - debian: bullseye
            php: 8.4
          - debian: trixie
            php: 8.2
          - debian: trixie
            php: 7.4
          - debian: bullseye
            platform: 'arm/v6'
          - debian: bullseye
            platform: 'arm/v7'


    env:
      # tag name de la forme: version-debian-http-debug e.g. 4.5-bullseye-http-debug
      TAG_NAME: ${{ matrix.debian }}${{ inputs.target == 'light' && '-http' || '' }}${{ github.ref_name != 'master' && '-dev' || '' }}
      TAG_LATEST_ENABLED: ${{ (matrix.debian == 'bullseye' && inputs.target == 'full' && github.ref_name == 'master') }}
      CACHE_NAME: ${{ matrix.debian }}-${{ matrix.platform }}-${{ matrix.php }}
      # RÃ©fÃ©rence vers le cache du registre
      REGISTRY_CACHE: ghcr.io/pifou25/docker-jeedom

    steps:
      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with secrets login & token - for pull to avoid error HTTP 429 Too many requests
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      -
        name: Prepare ${{ env.TAG_NAME }}:${{ matrix.platform }}
        # replace /  by - in platform value and registry cache name
        # list local registry mirror available images for debug
        run: |
          platform=linux/${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV
          echo "CACHE_TAG=buildcache-${CACHE_NAME//\//-}" >> $GITHUB_ENV

      -
        name: Checkout
        uses: actions/checkout@v4
          
      - 
        name: Login to GitHub Container Registry
        # ðŸ”¹ Service de cache Docker Registry ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_SECRET }}

      -
        name: Docker meta
        id: meta
        # https://github.com/marketplace/actions/docker-metadata-action
        uses: docker/metadata-action@v5
        with:
          # list of images names to use as base name for tags
          images: |
            ghcr.io/${{ env.REGISTRY_IMAGE }}
          # generate Docker tags based on the following events/attributes
          tags: |
            type=raw,value=${{ inputs.version_tag }}-${{ env.TAG_NAME }}
            # set latest tag for default branch
            type=raw,value=latest,enable=${{ env.TAG_LATEST_ENABLED }}

      -
        name: Set up QEMU
        # https://github.com/marketplace/actions/docker-setup-qemu
        # set up more platforms (default = all)
        uses: docker/setup-qemu-action@v3
      -
        name: Set up Docker Buildx
        id: buildx
        # https://github.com/marketplace/actions/docker-setup-buildx
        # set up a multi-platform builder for Docker containers
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-flags: --debug
          install: true
          driver: docker-container

      - 
        name: build ${{ inputs.version_tag }}-${{ env.TAG_NAME }}:${{ matrix.platform }}
        # id required for next step that check success
        id: buildJeedom
        # https://github.com/marketplace/actions/build-and-push-docker-images
        uses: docker/build-push-action@v5
        # continue to next step even in case of error
        continue-on-error: true
        with:
          context: build
          file: build/Dockerfile${{ inputs.target != 'light' && '.full' || '' }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            DEBIAN=${{ matrix.debian }}
            PHP=${{ matrix.php }}
            JEEDOM_REPO=${{ env.JEEDOM_REPO }}
            JEEDOM_VERSION=${{ env.JEEDOM_BRANCH }}
            XDEBUG=${{ env.XDEBUG }}
            XTRARGS=${{ github.ref_name != 'master' && '-dev' || '' }}
            VERSION_TAG=${{ inputs.version_tag }}
          platforms: linux/${{ matrix.platform }}
          cache-from: type=registry,ref=${{ env.REGISTRY_CACHE }}:${{ env.CACHE_TAG }}
          cache-to: type=registry,ref=${{ env.REGISTRY_CACHE }}:${{ env.CACHE_TAG }},mode=max
          outputs: type=image,name=ghcr.io/${{ env.REGISTRY_IMAGE }},push-by-digest=true,name-canonical=true,push=true

      - name: Check on failures ${{ inputs.version_tag }}-${{ env.TAG_NAME }}:${{ matrix.platform }}
        if: steps.buildJeedom.outcome != 'success'
        # some debug information in case of error, exit with error
        run: |
          echo "${{ matrix.platform}} ${{ matrix.debian }} PHP${{ matrix.php }} ${{ inputs.target }} branch ${{ env.JEEDOM_BRANCH }} debug=${{ env.XDEBUG }} has Errors! ðŸš€" >> $GITHUB_STEP_SUMMARY
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          Labels: ${{ steps.meta.outputs.labels }}
          EOF
          exit 1

      -
        name: Export digest ${{ inputs.version_tag }}-${{ env.TAG_NAME }}:${{ matrix.platform }}
        # export the digest file name into env var named DIGEST-${{ inputs.version_tag }}-${{ env.TAG_NAME }} for next step
        if: steps.buildJeedom.outcome == 'success'
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.buildJeedom.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"
          # export the build.log from image into the github summary
          docker run --platform linux/${{ matrix.platform }} -d --rm --name jeedom ghcr.io/${{ env.REGISTRY_IMAGE }}@${{ steps.buildJeedom.outputs.digest }} sleep 10
          docker cp jeedom:/tmp/build.log ./build.log
          cat ./build.log >> $GITHUB_STEP_SUMMARY
      -
        name: Upload digest ${{ inputs.version_tag }}-${{ env.TAG_NAME }}:${{ matrix.platform }}
        if: steps.buildJeedom.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          # env.PLATFORM_PAIR from step 1
          # get DIGEST-${TAG_NAME} env variable from previous step
          name: digests-${{ inputs.version_tag }}-${{ env.TAG_NAME }}-${{ env.PLATFORM_PAIR }}
          path: /tmp/digests/${{ env.DIGEST }}
          if-no-files-found: error
          retention-days: 1

  merge:
    # https://docs.docker.com/build/ci/github-actions/multi-platform/
    # merge previous builds from different runners & platforms into one common docker image
    runs-on: ubuntu-latest
    needs:
      - jbuild

    # same matrix as previous step except the platform
    strategy:
      fail-fast: false
      # limit to avoid error HTTP 409: too many requests
      max-parallel: 1
      matrix:
        debian: [bullseye, bookworm, trixie]
        php: [7.4, 8.2, 8.4]
        # only build bullseye with php7.4, bookworm with php8.2 and trixie with php8.4
        exclude:
          - debian: bookworm
            php: 7.4
          - debian: bookworm
            php: 8.4
          - debian: bullseye
            php: 8.2
          - debian: bullseye
            php: 8.4
          - debian: trixie
            php: 8.2
          - debian: trixie
            php: 7.4

    env:
      TAG_NAME: ${{ matrix.debian }}${{ inputs.target == 'light' && '-http' || '' }}${{ github.ref_name != 'master' && '-dev' || '' }}
      TAG_LATEST_ENABLED: ${{ (matrix.debian == 'bullseye' && inputs.target == 'full' && github.ref_name == 'master') }}

    steps:
      - name: init datetime value
        run: |
          echo "CURRENT_DATETIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV

      -
        name: Download digests
        # downloade artifacts whose name is the sha256 digest
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-${{ inputs.version_tag }}-${{ env.TAG_NAME }}-*
          merge-multiple: true

      - 
        name: Login to GitHub Container Registry
        # push to multi-registry
        # https://docs.docker.com/build/ci/github-actions/push-multi-registries/
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_SECRET }}
    
      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with secrets login & token
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Docker meta
        id: meta
        # https://github.com/marketplace/actions/docker-metadata-action
        uses: docker/metadata-action@v5
        with:
          # list of images from ghcr.io repo to use as base name for tags
          images: |
            ghcr.io/${{ env.REGISTRY_IMAGE }}
          # generate Docker tags based on the following events/attributes
          tags: |
            type=raw,value=${{ inputs.version_tag }}-${{ env.TAG_NAME }}
            # set latest tag for default branch
            type=raw,value=latest,enable=${{ env.TAG_LATEST_ENABLED }}
          # label chadburn for the "cron" container
          labels: |
            org.opencontainers.image.created=${{ env.CURRENT_DATETIME }}
            org.opencontainers.image.revision=${{ github.sha }}
            chadburn.enabled=true
            chadburn.job-exec.jeedom-cron.schedule=@every 1m
            chadburn.job-exec.jeedom-cron.command="/usr/local/bin/php /var/www/html/core/php/jeeCron.php >> /var/www/html/log/cron.log 2>&1"
 
      -
        name: Create manifest list and push ${{ inputs.version_tag }}-${{ env.TAG_NAME }} to Docker Hub
        working-directory: /tmp/digests
        run: |
          #!/usr/bin/env bash
          set -euo pipefail
          
          # VÃ©rifie qu'il y a bien des fichiers digest (produits par docker buildx build --push --output=type=digest)
          if ! ls | grep -qE '^[a-f0-9]{64}$'; then
            echo "âŒ Aucun digest trouvÃ© dans le rÃ©pertoire courant !" >> $GITHUB_STEP_SUMMARY
            echo "   (Tu dois exÃ©cuter 'docker buildx build --push --output=type=digest .' avant cette Ã©tape)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Affiche les fichiers digest pour info
          echo "ðŸ“¦ [DEBUG] Digests trouvÃ©s :"
          ls -alsh
          echo "ðŸ“¦ [DEBUG] liste de tags :"
          echo $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON")
          
          # exÃ©cute la commande docker buildx imagetools create complÃ¨te
          docker buildx imagetools create \
            $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf "ghcr.io/${REGISTRY_IMAGE}@sha256:%s " *)
          
          echo "âœ… [SUCCESS] Manifest multi-arch crÃ©Ã© avec succÃ¨s."
    
      - name: Push image to docker hub
        id: docker-push
        # continue to next step even in case of error
        continue-on-error: true
        run: |
            # install skopeo to copy images digests and tags
            sudo apt-get -y update
            sudo apt-get -y install skopeo

            attempt=0
            max_attempts=5
            until skopeo copy --all docker://ghcr.io/${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }} \
                docker://${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }}
            do
              attempt=$((attempt+1))
              if [ "$attempt" -ge "$max_attempts" ]; then
                echo "âŒ Trop de tentatives, abandon. (${attempt})" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
              echo "âš ï¸ Erreur 429, attente avant retry (${attempt})..." >> $GITHUB_STEP_SUMMARY
              sleep $((attempt * 10))  # pause progressive : 10s, 20s, 30sâ€¦
            done

      -
        name: Login to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USER }}
          password: ${{ secrets.QUAY_PASSWORD }}
         
      - name: Push ${{ inputs.version_tag }}-${{ env.TAG_NAME }} to Quay.io
        id: quay-push
        # continue to next step even in case of error
        continue-on-error: true
        run: |
          skopeo copy --all docker://ghcr.io/${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }} \
                docker://quay.io/${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }}

      -
        name: Login to nico private repository
        # https://github.com/marketplace/actions/docker-login
        uses: docker/login-action@v3
        with:
          registry: reg.nico.si
          username: ${{ github.repository_owner }}
          password: ${{ secrets.NICO_PASSWORD }}
         
      - name: Push image to nico.si
        id: nico-push
        # continue to next step even in case of error
        continue-on-error: true
        run: |
          skopeo copy --all docker://ghcr.io/${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }} \
                docker://reg.nico.si/${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }}

      - name: copy also latest tag if required
        if: ${{ env.TAG_LATEST_ENABLED }}
        id: latest-push
        # continue to next step even in case of error
        continue-on-error: true
        run: |
          skopeo copy --all docker://ghcr.io/${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }} \
                docker://quay.io/${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }}
          skopeo copy --all docker://ghcr.io/${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }} \
                docker://reg.nico.si/${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }}
          skopeo copy --all docker://ghcr.io/${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }} \
                docker://${{ env.REGISTRY_IMAGE }}:${{ inputs.version_tag }}-${{ env.TAG_NAME }}

      - name: Check push into quay.io ${{ inputs.version_tag }}-${{ env.TAG_NAME }}
        if: steps.quay-push.outcome != 'success' || steps.docker-push.outcome != 'success' || steps.nico-push.outcome != 'success' || steps.latest-push.outcome != 'success'
        run: |
          if [ "${{ steps.docker-push.outcome }}" != "success" ]; then \
            echo "Fail pushing ${{ inputs.version_tag }}-${{ env.TAG_NAME }} to docker.io ! ðŸš€ (probably error HTTP 429 Too many requests)" >> $GITHUB_STEP_SUMMARY; \
          else \
            echo "Successfull pushing ${{ inputs.version_tag }}-${{ env.TAG_NAME }} to docker.io ðŸš€" >> $GITHUB_STEP_SUMMARY; \
          fi
          if [ "${{ steps.quay-push.outcome }}" != "success" ]; then \
            echo "Fail pushing ${{ inputs.version_tag }}-${{ env.TAG_NAME }} to quay.io ! ðŸš€ (probably error HTTP 429 Too many requests)" >> $GITHUB_STEP_SUMMARY; \
          else \
            echo "Successfull pushing ${{ inputs.version_tag }}-${{ env.TAG_NAME }} to quay.io ðŸš€" >> $GITHUB_STEP_SUMMARY; \
          fi
          if [ "${{ steps.nico-push.outcome }}" != "success" ]; then \
            echo "Fail pushing ${{ inputs.version_tag }}-${{ env.TAG_NAME }} to nico.si ! ðŸš€ ( ?? )" >> $GITHUB_STEP_SUMMARY; \
          else \
            echo "Successfull pushing ${{ inputs.version_tag }}-${{ env.TAG_NAME }} to nico.si ðŸš€" >> $GITHUB_STEP_SUMMARY; \
          fi
          if [ ${{ env.TAG_LATEST_ENABLED }} != 'false' ]; then \
            if [ "${{ steps.latest-push.outcome }}" != "success" ]; then \
              echo "Fail pushing latest tag ! ðŸš€ ( ?? )" >> $GITHUB_STEP_SUMMARY; \
            else \
              echo "Successfull pushing latest tag ðŸš€" >> $GITHUB_STEP_SUMMARY; \
            fi \
          fi

  conclusion:
    # login to Docker.io and check remaining rate limit
    needs: [merge]
    if: always()
    runs-on: ubuntu-latest
    steps:

      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with secrets login & token - for pull to avoid error HTTP 429 Too many requests
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      -
        name: Checkout
        uses: actions/checkout@v4

      - name: Run DockerHub rate limit final check
        id: ratecheckFinal
        run: |
          chmod +x .github/scripts/rate_limit.sh
          ./.github/scripts/rate_limit.sh

      - name: Add summary to Job Summary
        run: |
          echo "### ðŸ³ DockerHub Pull Limit" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.ratecheckFinal.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
      - name: Remove useless artifacts
        # https://github.com/marketplace/actions/remove-artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '5 seconds'
