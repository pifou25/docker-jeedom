name: Docker Multiplatform Build ci
# master branch build image from jeedom/core:master repo
# develop branch build image from pifou25/jeedom-core:develop repo

on:
  push:
    branches:
      - master
      - develop
  # this is to manually trigger the worklow
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Reason'     
        default: 'Manual launch'

# no concurrency, cancel previous running workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # used to download jeedom source
  JEEDOM_REPO: ${{ github.ref_name == 'master' && 'jeedom/core' || 'pifou25/jeedom-core' }}
  # branch to use: master if the current branch is master, develop if not
  # this is used to set the jeedom version in the Dockerfile
  JEEDOM_BRANCH: ${{ github.ref_name == 'master' && 'master' || 'develop' }}
  # destination docker registry image name
  REGISTRY_IMAGE: pifou25/jeedom
  # XDEBUG enabled by default for develop and beta branches
  XDEBUG: ${{ github.ref_name == 'master' && 'false' || 'true' }}
  # Active BuildKit
  DOCKER_BUILDKIT: 1

jobs:
  # clean runner and Lint the Dockerfile
  initStep:
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v4.1.2
      - name: Docker Lint
        # https://github.com/marketplace/actions/hadolint-action
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: build/Dockerfile
          no-fail: true
          verbose: true
      - name: Docker Lint
        # https://github.com/marketplace/actions/hadolint-action
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: build/Dockerfile.full
          no-fail: true
          verbose: true
      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with login & secrets token to get our private rate limit
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Run DockerHub rate limit check
        id: ratecheck
        run: |
          chmod +x .github/scripts/rate_limit.sh
          ./.github/scripts/rate_limit.sh

      - name: Add summary to Job Summary
        run: |
          echo "### üê≥ DockerHub Pull Limit" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.ratecheck.outputs.summary }}" >> $GITHUB_STEP_SUMMARY

      - name: check Docker.io rate limit
        if: ${{ steps.ratecheck.outputs.remaining && (steps.ratecheck.outputs.remaining < 10) }}
        run: |
          echo "‚ö†Ô∏è Il reste moins de 10 pulls : ${{ steps.ratecheck.outputs.remaining }} / ${{ steps.ratecheck.outputs.limit }}" >> $GITHUB_STEP_SUMMARY && exit 1

  jbuild:
    # https://docs.docker.com/build/ci/github-actions/multi-platform/
    # distribute build across multiple runners
    # This step  build the same image on different runners / platforms
    runs-on: ubuntu-latest
    needs: initStep

    # continue to next job even if there are some errors in jbuild job
    continue-on-error: true
    strategy:
      # do every matrix combination, don't stop on errors
      fail-fast: false
      # limit to avoid error HTTP 409: too many requests
      max-parallel: 3
      matrix:
        target: ["light" , "full"]
        debian: [bullseye, bookworm, trixie]
        php: [7.4, 8.2, 8.4]
        # linux/amd64,linux/amd64/v2,linux/amd64/v3,linux/arm64,linux/riscv64,linux/ppc64le,linux/s390x,linux/386,linux/mips64le,linux/mips64,linux/arm/v7,linux/arm/v6
        platform: [amd64, arm64, arm/v6, arm/v7]
        # only build bullseye with php7.4, bookworm with php8.2 and trixie with php8.4
        exclude:
          - target: full
          - debian: bullseye
          - debian: trixie
          - php: 7.4
          - php: 8.4
          - debian: bookworm
            php: 7.4
          - debian: bookworm
            php: 8.4
          - debian: bullseye
            php: 8.2
          - debian: bullseye
            php: 8.4
          - debian: trixie
            php: 8.2
          - debian: trixie
            php: 7.4
          - debian: bullseye
            platform: 'arm/v6'
          - debian: bullseye
            platform: 'arm/v7'


    env:
      # tag name de la forme: debian-php-light-debug-dev e.g. bullseye-8.2-light-debug-dev
      TAG_NAME: ${{ matrix.debian }}-${{ matrix.php }}${{ matrix.target == 'light' && '-light' || '' }}${{ github.ref_name != 'master' && '-dev' || '' }}
      TAG_LATEST_ENABLED: ${{ (matrix.debian == 'bullseye' && matrix.target == 'full' && github.ref_name == 'master') }}
      CACHE_NAME: ${{ matrix.debian }}-${{ matrix.platform }}-${{ matrix.php }}
      # R√©f√©rence vers le cache du registre
      REGISTRY_CACHE: ghcr.io/pifou25/docker-jeedom

    steps:
      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with secrets login & token - for pull to avoid error HTTP 429 Too many requests
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      -
        name: Prepare ${{ env.TAG_NAME }}:${{ matrix.platform }}
        # replace /  by - in platform value and registry cache name
        # list local registry mirror available images for debug
        run: |
          platform=linux/${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV
          echo "CACHE_TAG=buildcache-${CACHE_NAME//\//-}" >> $GITHUB_ENV

      -
        name: Checkout
        uses: actions/checkout@v4
          
      - 
        name: Login to GitHub Container Registry
        # üîπ Service de cache Docker Registry ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_SECRET }}

      -
        name: Docker meta
        id: meta
        # https://github.com/marketplace/actions/docker-metadata-action
        uses: docker/metadata-action@v5
        with:
          # list of images names to use as base name for tags
          images: |
            ghcr.io/${{ env.REGISTRY_IMAGE }}
          # generate Docker tags based on the following events/attributes
          tags: |
            type=raw,value=${{ env.TAG_NAME }}
            # set latest tag for default branch
            type=raw,value=latest,enable=${{ env.TAG_LATEST_ENABLED }}

      -
        name: Set up QEMU
        # https://github.com/marketplace/actions/docker-setup-qemu
        # set up more platforms (default = all)
        uses: docker/setup-qemu-action@v3
      -
        name: Set up Docker Buildx
        id: buildx
        # https://github.com/marketplace/actions/docker-setup-buildx
        # set up a multi-platform builder for Docker containers
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-flags: --debug
          install: true
          driver: docker-container

      - 
        name: build ${{ env.TAG_NAME }}:${{ matrix.platform }}
        # id required for next step that check success
        id: buildJeedom
        # https://github.com/marketplace/actions/build-and-push-docker-images
        uses: docker/build-push-action@v5
        # continue to next step even in case of error
        continue-on-error: true
        with:
          context: build
          file: build/Dockerfile${{ matrix.target != 'light' && '.full' || '' }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            DEBIAN=${{ matrix.debian }}
            PHP=${{ matrix.php }}
            JEEDOM_REPO=${{ env.JEEDOM_REPO }}
            JEEDOM_VERSION=${{ env.JEEDOM_BRANCH }}
            XDEBUG=${{ env.XDEBUG }}
            XTRARGS=${{ env.XDEBUG && '-light-dev' || '-light' }}
          platforms: linux/${{ matrix.platform }}
          cache-from: type=registry,ref=${{ env.REGISTRY_CACHE }}:${{ env.CACHE_TAG }}
          cache-to: type=registry,ref=${{ env.REGISTRY_CACHE }}:${{ env.CACHE_TAG }},mode=max
          outputs: type=image,name=ghcr.io/${{ env.REGISTRY_IMAGE }},push-by-digest=true,name-canonical=true,push=true

      - name: Check on failures ${{ env.TAG_NAME }}:${{ matrix.platform }}
        if: steps.buildJeedom.outcome != 'success'
        # some debug information in case of error, exit with error
        run: |
          echo "${{ matrix.platform}} ${{ matrix.debian }} PHP${{ matrix.php }} ${{ matrix.target }} branch ${{ env.JEEDOM_BRANCH }} debug=${{ env.XDEBUG }} has Errors! üöÄ" >> $GITHUB_STEP_SUMMARY
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          Labels: ${{ steps.meta.outputs.labels }}
          EOF
          exit 1

      -
        name: Export digest ${{ env.TAG_NAME }}:${{ matrix.platform }}
        # export the digest file name into env var named DIGEST-${TAG_NAME} for next step
        if: steps.buildJeedom.outcome == 'success'
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.buildJeedom.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"
      -
        name: Upload digest ${{ env.TAG_NAME }}:${{ matrix.platform }}
        if: steps.buildJeedom.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          # env.PLATFORM_PAIR from step 1
          # get DIGEST-${TAG_NAME} env variable from previous step
          name: digests-${{ env.TAG_NAME }}-${{ env.PLATFORM_PAIR }}
          path: /tmp/digests/${{ env.DIGEST }}
          if-no-files-found: error
          retention-days: 1

  merge:
    # https://docs.docker.com/build/ci/github-actions/multi-platform/
    # merge previous builds from different runners & platforms into one common docker image
    runs-on: ubuntu-latest
    needs:
      - jbuild

    # same matrix as previous step except the platform
    strategy:
      fail-fast: false
      # limit to avoid error HTTP 409: too many requests
      max-parallel: 1
      matrix:
        target: ["light" , "full"]
        debian: [bullseye, bookworm, trixie]
        php: [7.4, 8.2, 8.4]
        # only build bullseye with php7.4, bookworm with php8.2 and trixie with php8.4
        exclude:
          - target: full
          - debian: bullseye
          - debian: trixie
          - php: 7.4
          - php: 8.4
          - debian: bookworm
            php: 7.4
          - debian: bookworm
            php: 8.4
          - debian: bullseye
            php: 8.2
          - debian: bullseye
            php: 8.4
          - debian: trixie
            php: 8.2
          - debian: trixie
            php: 7.4

    env:
      TAG_NAME: ${{ matrix.debian }}-${{ matrix.php }}${{ matrix.target == 'light' && '-light' || '' }}${{ github.ref_name != 'master' && '-dev' || '' }}
      TAG_LATEST_ENABLED: ${{ (matrix.debian == 'bullseye' && matrix.target == 'full' && github.ref_name == 'master') }}

    steps:
      - name: init datetime value
        run: |
          echo "CURRENT_DATETIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV

      -
        name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-${{ env.TAG_NAME }}-*
          merge-multiple: true

      - 
        name: Login to GitHub Container Registry
        # push to multi-registry
        # https://docs.docker.com/build/ci/github-actions/push-multi-registries/
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_SECRET }}
    
      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with secrets login & token
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Docker meta
        id: meta
        # https://github.com/marketplace/actions/docker-metadata-action
        uses: docker/metadata-action@v5
        with:
          # list of images from ghcr.io repo to use as base name for tags
          images: |
            ghcr.io/${{ env.REGISTRY_IMAGE }}
          # generate Docker tags based on the following events/attributes
          tags: |
            type=raw,value=${{ env.TAG_NAME }}
            # set latest tag for default branch
            type=raw,value=latest,enable=${{ env.TAG_LATEST_ENABLED }}
          # label chadburn for the "cron" container
          labels: |
            org.opencontainers.image.created=${{ env.CURRENT_DATETIME }}
            org.opencontainers.image.revision=${{ github.sha }}
            chadburn.enabled=true
            chadburn.job-exec.jeedom-cron.schedule=@every 1m
            chadburn.job-exec.jeedom-cron.command="/usr/local/bin/php /var/www/html/core/php/jeeCron.php >> /var/www/html/log/cron.log 2>&1"
 
      -
        name: Create manifest list and push ${{ env.TAG_NAME }} to Docker Hub
        working-directory: /tmp/digests
        run: |
          #!/usr/bin/env bash
          set -euo pipefail
          
          echo "üîç [DEBUG] DOCKER_METADATA_OUTPUT_JSON:"
          echo "$DOCKER_METADATA_OUTPUT_JSON" | jq .
          
          # R√©cup√®re le premier tag complet (ex: ghcr.io/pifou25/jeedom:latest)
          FIRST_TAG=$(jq -r '.tags[0]' <<< "$DOCKER_METADATA_OUTPUT_JSON")
          
          # Supprime le tag pour ne garder que la partie image (ex: ghcr.io/pifou25/jeedom)
          # ou juste pifou25/jeedom si pas de registre explicite
          REGISTRY_REPO="${FIRST_TAG%%:*}"
          
          echo "üß© [INFO] Repository base detected: $REGISTRY_REPO"
          
          # V√©rifie qu'il y a bien des fichiers digest (produits par docker buildx build --push --output=type=digest)
          if ! ls | grep -qE '^[a-f0-9]{64}$'; then
            echo "‚ùå Aucun digest trouv√© dans le r√©pertoire courant !" >> $GITHUB_STEP_SUMMARY
            echo "   (Tu dois ex√©cuter 'docker buildx build --push --output=type=digest .' avant cette √©tape)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Affiche les fichiers digest pour info
          echo "üì¶ [DEBUG] Digests trouv√©s :"
          ls
          
          # Cr√©e la commande docker buildx imagetools create compl√®te
          CMD="docker buildx imagetools create \
            $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '%s@sha256:%s ' "$REGISTRY_REPO" *)"
          
          echo "üöÄ [INFO] Commande ex√©cut√©e :"
          echo "$CMD"
          
          # Ex√©cution r√©elle
          eval "$CMD"
          
          echo "‚úÖ [SUCCESS] Manifest multi-arch cr√©√© avec succ√®s."
    
      - name: Push image to GHCR
        id: ghcr-push
        # continue to next step even in case of error
        continue-on-error: true
        run: |
            attempt=0
            max_attempts=5
            until docker buildx imagetools create \
              ${{ env.TAG_LATEST_ENABLED == true && '--tag ghcr.io/${REGISTRY_IMAGE}:latest' || '' }} \
              --tag ghcr.io/${{ env.REGISTRY_IMAGE }}:${{ env.TAG_NAME }} \
              ${{ env.REGISTRY_IMAGE }}:${{ env.TAG_NAME }}
            do
              attempt=$((attempt+1))
              if [ "$attempt" -ge "$max_attempts" ]; then
                echo "‚ùå Trop de tentatives, abandon. (${attempt})" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
              echo "‚ö†Ô∏è Erreur 429, attente avant retry (${attempt})..." >> $GITHUB_STEP_SUMMARY
              sleep $((attempt * 10))  # pause progressive : 10s, 20s, 30s‚Ä¶
            done

      -
        name: Login to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USER }}
          password: ${{ secrets.QUAY_PASSWORD }}
         
      - name: Push ${{ env.TAG_NAME }} to Quay.io
        id: quay-push
        # continue to next step even in case of error
        continue-on-error: true
        run: |
          docker buildx imagetools create \
            ${{ env.TAG_LATEST_ENABLED && '--tag quay.io/${REGISTRY_IMAGE}:latest' || '' }} \
            --tag quay.io/${{ env.REGISTRY_IMAGE }}:${{ env.TAG_NAME }} \
            ${{ env.REGISTRY_IMAGE }}:${{ env.TAG_NAME }}
      -
        name: Login to nico private repository
        # https://github.com/marketplace/actions/docker-login
        uses: docker/login-action@v3
        with:
          registry: reg.nico.si
          username: ${{ github.repository_owner }}
          password: ${{ secrets.NICO_PASSWORD }}
         
      - name: Push image to nico.si
        id: nico-push
        # continue to next step even in case of error
        continue-on-error: true
        run: |
          docker buildx imagetools create \
            ${{ env.TAG_LATEST_ENABLED == true && '--tag reg.nico.si/${REGISTRY_IMAGE}:latest' || '' }} \
            --tag reg.nico.si/${{ env.REGISTRY_IMAGE }}:${{ env.TAG_NAME }} \
            ${{ env.REGISTRY_IMAGE }}:${{ env.TAG_NAME }}

      - name: Check push into quay.io ${{ env.TAG_NAME }}
        if: steps.quay-push.outcome != 'success' || steps.ghcr-push.outcome != 'success'
        run: |
          if [ "${{ steps.ghcr-push.outcome }}" != "success" ]; then \
            echo "Fail pushing ${TAG_NAME} to ghcr.io ! üöÄ (probably error HTTP 429 Too many requests)" >> $GITHUB_STEP_SUMMARY; \
          else \
            echo "Successfull pushing ${TAG_NAME} to ghcr.io üöÄ" >> $GITHUB_STEP_SUMMARY; \
          fi
          if [ "${{ steps.quay-push.outcome }}" != "success" ]; then \
            echo "Fail pushing ${TAG_NAME} to quay.io ! üöÄ (probably error HTTP 429 Too many requests)" >> $GITHUB_STEP_SUMMARY; \
          else \
            echo "Successfull pushing ${TAG_NAME} to quay.io üöÄ" >> $GITHUB_STEP_SUMMARY; \
          fi
          if [ "${{ steps.nico-push.outcome }}" != "success" ]; then \
            echo "Fail pushing ${TAG_NAME} to nico.si ! üöÄ ( ?? )" >> $GITHUB_STEP_SUMMARY; \
          else \
            echo "Successfull pushing ${TAG_NAME} to nico.si üöÄ" >> $GITHUB_STEP_SUMMARY; \
          fi

  conclusion:
    # login to Docker.io and check remaining rate limit
    needs: [merge]
    if: always()
    runs-on: ubuntu-latest
    steps:

      -
        name: Login to DockerHub
        # https://github.com/marketplace/actions/docker-login
        # login to DockerHub with secrets login & token - for pull to avoid error HTTP 429 Too many requests
        uses: docker/login-action@v3
        with:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      -
        name: Checkout
        uses: actions/checkout@v4

      - name: Run DockerHub rate limit final check
        id: ratecheckFinal
        run: |
          chmod +x .github/scripts/rate_limit.sh
          ./.github/scripts/rate_limit.sh

      - name: Add summary to Job Summary
        run: |
          echo "### üê≥ DockerHub Pull Limit" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.ratecheckFinal.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
      - name: Remove useless artifacts
        # https://github.com/marketplace/actions/remove-artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '5 seconds'
